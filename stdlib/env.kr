// KORE Standard Library - Environment Module
// Provides access to command-line arguments and environment variables
//
// Essential for building CLI tools like the self-hosted compiler.

// =============================================================================
// Command Line Arguments
// =============================================================================

/// Get all command-line arguments as an array.
/// The first element is typically the program name.
///
/// Example:
///     let args = env::args()
///     if len(args) < 2:
///         println("Usage: kore <file.kr>")
///         exit(1)
///     let filename = args[1]
///
pub fn args() -> Array<String>:
    // Maps to built-in `env("args")` or dedicated function
    return env("args")

/// Get a specific argument by index.
/// Returns None if index is out of bounds.
pub fn arg(index: Int) -> Option<String>:
    let all_args = args()
    if index >= 0 && index < len(all_args):
        return Some(all_args[index])
    return None

/// Get the number of command-line arguments.
pub fn argc() -> Int:
    return len(args())

// =============================================================================
// Environment Variables
// =============================================================================

/// Get an environment variable by name.
/// Returns the value or an empty string if not set.
///
/// Example:
///     let home = env::get("HOME")
///     let path = env::get("PATH")
///
pub fn get(name: String) -> String:
    return env(name)

/// Get an environment variable with a default fallback.
pub fn get_or(name: String, default: String) -> String:
    let val = env(name)
    if len(val) == 0:
        return default
    return val

/// Check if an environment variable is set.
pub fn has(name: String) -> Bool:
    return len(env(name)) > 0

// =============================================================================
// Process Control
// =============================================================================

/// Exit the program with the given status code.
/// 0 = success, non-zero = error.
pub fn exit(code: Int) -> Unit:
    exit(code)

/// Get the current working directory.
pub fn cwd() -> String:
    return env("cwd")

// =============================================================================
// Args Parser (Simple CLI Parsing)
// =============================================================================

/// Simple argument parser for CLI tools.
/// Supports flags (--flag) and key-value (--key=value or --key value).
struct ArgParser:
    args: Array<String>
    index: Int

impl ArgParser:
    /// Create a parser from command-line args (skipping program name).
    pub fn new() -> ArgParser:
        let all = args()
        // Skip the first arg (program name)
        let rest = []
        for i in range(1, len(all)):
            push(rest, all[i])
        return ArgParser { args: rest, index: 0 }
    
    /// Check if a flag is present (e.g., "--verbose" or "-v").
    pub fn has_flag(self, flag: String) -> Bool:
        for arg in self.args:
            if arg == flag:
                return true
        return false
    
    /// Get the value of a keyed argument (e.g., "--target=wasm" or "--target wasm").
    pub fn get_value(self, key: String) -> Option<String>:
        let i = 0
        while i < len(self.args):
            let arg = self.args[i]
            // Check for --key=value format
            if starts_with(arg, key + "="):
                return Some(substring(arg, len(key) + 1, len(arg)))
            // Check for --key value format
            if arg == key && i + 1 < len(self.args):
                return Some(self.args[i + 1])
            i = i + 1
        return None
    
    /// Get positional arguments (non-flag arguments).
    pub fn positional(self) -> Array<String>:
        let result = []
        for arg in self.args:
            if !starts_with(arg, "-"):
                push(result, arg)
        return result
    
    /// Get the first positional argument (usually the input file).
    pub fn input_file(self) -> Option<String>:
        let pos = self.positional()
        if len(pos) > 0:
            return Some(pos[0])
        return None
