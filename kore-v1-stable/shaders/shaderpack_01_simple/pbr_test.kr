// PBR-style shader with advanced features
shader fragment PBREffect(position: Vec4, uv: Vec2, normal: Vec3) -> Vec4:
    uniform time: Float @0
    uniform roughness: Float @1
    uniform metallic: Float @2
    uniform albedo_map: Sampler2D @3
    uniform normal_map: Sampler2D @4
    uniform roughness_map: Sampler2D @5
    uniform light_pos: Vec3 @6
    uniform camera_pos: Vec3 @7
    
    // Sample textures
    let albedo = sample(albedo_map, uv).rgb
    let normal_sample = sample(normal_map, uv).rgb
    let roughness_sample = sample(roughness_map, uv).r
    
    // Unpack normal from [0,1] to [-1,1]
    let unpacked_normal = normal_sample * 2.0 - 1.0
    let N = normalize(unpacked_normal)
    
    // Calculate view direction
    let world_pos = position.xyz
    let V = normalize(camera_pos - world_pos)
    
    // Calculate light direction
    let L = normalize(light_pos - world_pos)
    let H = normalize(V + L)
    
    // Lighting calculations
    let NdotL = max(dot(N, L), 0.0)
    let NdotV = max(dot(N, V), 0.0)
    let NdotH = max(dot(N, H), 0.0)
    
    // Fresnel (simplified Schlick approximation)
    let F0 = mix(vec3(0.04), albedo, metallic)
    let fresnel_factor = pow(1.0 - NdotV, 5.0)
    let F = F0 + (vec3(1.0) - F0) * fresnel_factor
    
    // Roughness-based specular
    let roughness_final = roughness * roughness_sample
    let specular = pow(NdotH, (1.0 - roughness_final) * 128.0)
    
    // Combine lighting
    let diffuse = albedo * NdotL
    let spec = F * specular
    let ambient = albedo * 0.03
    
    let final_color = ambient + diffuse + spec
    
    return vec4(final_color, 1.0)
