// KORE Async/Await Test
// Tests the state machine transformation

use std::poll

// Simple async function with no awaits (should work as baseline)
async fn simple_async() -> Int:
    return 42

// Async function with one await
async fn fetch_data(id: Int) -> String:
    println("Starting fetch...")
    let result = await delayed_value(id)
    println("Fetch complete!")
    return result

// Async function with multiple awaits
async fn process_pipeline(x: Int) -> Int:
    println("Step 1: Starting...")
    let a = await add_async(x, 10)
    println("Step 2: Got a")
    let b = await multiply_async(a, 2)
    println("Step 3: Got b")
    let c = await add_async(b, 5)
    println("Done!")
    return c

// Mock async functions that return immediately (for testing)
// In real code these would do I/O
fn delayed_value(id: Int) -> DelayedValue_Future:
    return DelayedValue_Future { value: id, ready: true }

struct DelayedValue_Future:
    value: Int
    ready: Bool

fn DelayedValue_Future_poll(self: DelayedValue_Future) -> Poll<String>:
    if self.ready:
        return Poll::Ready("data_" + str(self.value))
    else:
        return Poll::Pending

fn add_async(a: Int, b: Int) -> Add_Future:
    return Add_Future { result: a + b }

struct Add_Future:
    result: Int

fn Add_Future_poll(self: Add_Future) -> Poll<Int>:
    return Poll::Ready(self.result)

fn multiply_async(a: Int, b: Int) -> Multiply_Future:
    return Multiply_Future { result: a * b }

struct Multiply_Future:
    result: Int

fn Multiply_Future_poll(self: Multiply_Future) -> Poll<Int>:
    return Poll::Ready(self.result)

// Simple executor that polls until ready
fn run<T>(future: impl Future) -> T:
    loop:
        match future.poll():
            Poll::Ready(val) => return val
            Poll::Pending => continue

fn main():
    println("=== KORE Async/Await Test ===")
    
    // Test 1: Simple async with no awaits
    println("Test 1: Simple async function")
    let fut1 = simple_async()
    println("Created future")
    // For now, just verify the future was created
    
    // Test 2: Async with one await
    println("Test 2: One await")
    let fut2 = fetch_data(42)
    println("Created fetch_data future")
    
    // Test 3: Multiple awaits
    println("Test 3: Multiple awaits") 
    let fut3 = process_pipeline(5)
    println("Created process_pipeline future")
    
    println("=== Test Complete ===")
